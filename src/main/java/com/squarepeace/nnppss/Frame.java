/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JFrame.java to edit this template
 */
package com.squarepeace.nnppss;

import com.squarepeace.nnppss.model.Console;
import com.squarepeace.nnppss.model.Game;
import com.squarepeace.nnppss.service.ConfigManager;
import com.squarepeace.nnppss.service.DownloadService;
import com.squarepeace.nnppss.service.GameRepository;
import com.squarepeace.nnppss.service.PackageService;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

import javax.swing.JButton;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.JTable;
import javax.swing.RowFilter;
import javax.swing.SwingUtilities;
import javax.swing.Timer;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import javax.swing.table.DefaultTableModel;
import javax.swing.table.TableRowSorter;

public class Frame extends javax.swing.JFrame implements ActionListener {

    private DefaultTableModel originalModel;
    private TableRowSorter<DefaultTableModel> rowSorter;

    private final ConfigManager configManager;
    private final GameRepository gameRepository;
    private final DownloadService downloadService;
    private final PackageService packageService;

    private boolean downloadPaused = false;
    private boolean downloading = false;

    private List<Game> downloadList = new ArrayList<>();

    private final Map<String, javax.swing.JProgressBar> progressBarsByUrl = new LinkedHashMap<>();
    private JPanel downloadsPanel;
    private JScrollPane downloadsScroll;
    private int activeDownloadCount = 0;
    // Tracking for speed calculation per download
    private final Map<String, Long> lastBytesByUrl = new LinkedHashMap<>();
    private final Map<String, Long> lastTimeByUrl = new LinkedHashMap<>();
    // Smoothing + throttle maps
    private final Map<String, Double> smoothedSpeedMibByUrl = new LinkedHashMap<>();
    private final Map<String, Long> lastUiUpdateMsByUrl = new LinkedHashMap<>();
    private final Map<String, Integer> lastProgressPercentByUrl = new LinkedHashMap<>();

    public Frame(ConfigManager configManager, GameRepository gameRepository, DownloadService downloadService, PackageService packageService) {
        this.configManager = configManager;
        this.gameRepository = gameRepository;
        this.downloadService = downloadService;
        this.packageService = packageService;
        
        initComponents();
        jbResumeAndPause.setEnabled(false);

        // Debounced search filtering using DocumentListener + Swing Timer
        final Timer debounceTimer = new Timer(250, e -> {
            filtrarTablaPorTextoYRegion(jtfSearch.getText(), (String) jcbRegion.getSelectedItem());
        });
        debounceTimer.setRepeats(false);
        jtfSearch.getDocument().addDocumentListener(new DocumentListener() {
            private void changed() {
                debounceTimer.restart();
            }
            public void insertUpdate(DocumentEvent e) { changed(); }
            public void removeUpdate(DocumentEvent e) { changed(); }
            public void changedUpdate(DocumentEvent e) { changed(); }
        });
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        bgConsoles = new javax.swing.ButtonGroup();
        jPanel1 = new javax.swing.JPanel();
        jbsearch = new javax.swing.JLabel();
        jbRefresh = new javax.swing.JButton();
        jtfSearch = new javax.swing.JTextField();
        jcbRegion = new javax.swing.JComboBox<>();
        jScrollPane1 = new javax.swing.JScrollPane();
        jtData = new javax.swing.JTable();
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jbSetting = new javax.swing.JButton();
        jrbPsvita = new javax.swing.JRadioButton();
        jrbPsp = new javax.swing.JRadioButton();
        jbDownloadList = new javax.swing.JButton();
        jrbPsx = new javax.swing.JRadioButton();
        jbResumeAndPause = new javax.swing.JButton();
        downloadsPanel = new JPanel();
        downloadsPanel.setLayout(new javax.swing.BoxLayout(downloadsPanel, javax.swing.BoxLayout.Y_AXIS));
        downloadsScroll = new JScrollPane(downloadsPanel);
        downloadsScroll.setVerticalScrollBarPolicy(JScrollPane.VERTICAL_SCROLLBAR_ALWAYS);

        setDefaultCloseOperation(javax.swing.WindowConstants.EXIT_ON_CLOSE);
        setTitle("NNPPSS");

        jPanel1.setName("NNPPSS"); // NOI18N

        jbsearch.setText("Search:");

        jbRefresh.setText("Refresh");
        jbRefresh.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbRefreshActionPerformed(evt);
            }
        });

        // KeyListener removed; using debounced DocumentListener above for filtering.

        jcbRegion.addItemListener(new java.awt.event.ItemListener() {
            public void itemStateChanged(java.awt.event.ItemEvent evt) {
                jcbRegionItemStateChanged(evt);
            }
        });

        jtData.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mousePressed(java.awt.event.MouseEvent evt) {
                jtDataMousePressed(evt);
            }
        });
        jScrollPane1.setViewportView(jtData);

        jLabel1.setText("Region: ");

        jLabel2.setText("Console:");

        jbSetting.setText("Setting");
        jbSetting.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbSettingActionPerformed(evt);
            }
        });

        bgConsoles.add(jrbPsvita);
        jrbPsvita.setText("Psvita");
        jrbPsvita.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jrbPsvitaActionPerformed(evt);
            }
        });

        bgConsoles.add(jrbPsp);
        jrbPsp.setText("Psp");
        jrbPsp.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jrbPspActionPerformed(evt);
            }
        });

        jbDownloadList.setText("Download list");
        jbDownloadList.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbDownloadListActionPerformed(evt);
            }
        });

        bgConsoles.add(jrbPsx);
        jrbPsx.setText("Psx");
        jrbPsx.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jrbPsxActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel1Layout.createSequentialGroup()
                .addGap(15, 15, 15)
                .addComponent(jLabel2)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jrbPsvita)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jrbPsp)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jrbPsx)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(jbDownloadList, javax.swing.GroupLayout.PREFERRED_SIZE, 166, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(40, 40, 40)
                .addComponent(jLabel1)
                .addGap(18, 18, 18)
                .addComponent(jcbRegion, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(jbsearch)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jtfSearch, javax.swing.GroupLayout.PREFERRED_SIZE, 162, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(31, 31, 31)
                .addComponent(jbRefresh)
                .addGap(18, 18, 18)
                .addComponent(jbSetting)
                .addContainerGap())
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 1179, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(0, 0, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(19, 19, 19)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jcbRegion, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jbsearch)
                    .addComponent(jtfSearch, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jbRefresh)
                    .addComponent(jLabel1)
                    .addComponent(jLabel2)
                    .addComponent(jbSetting)
                    .addComponent(jrbPsvita)
                    .addComponent(jrbPsp)
                    .addComponent(jbDownloadList)
                    .addComponent(jrbPsx))
                .addGap(26, 26, 26)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 552, Short.MAX_VALUE)
                .addContainerGap())
        );

        jbResumeAndPause.setText("Pause");
        jbResumeAndPause.setActionCommand(":p");
        jbResumeAndPause.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jbResumeAndPauseActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(0, 0, Short.MAX_VALUE))
            .addGroup(layout.createSequentialGroup()
                .addGap(40, 40, 40)
                .addComponent(downloadsScroll, javax.swing.GroupLayout.PREFERRED_SIZE, 1000, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(jbResumeAndPause)
                .addContainerGap(40, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(downloadsScroll, javax.swing.GroupLayout.DEFAULT_SIZE, 200, Short.MAX_VALUE)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jbResumeAndPause)
                        .addGap(0, 0, Short.MAX_VALUE)))
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

        private void jtDataMousePressed(java.awt.event.MouseEvent evt) {
        int selectedRow = jtData.getSelectedRow();
        if (selectedRow != -1) {
            int modelRowIndex = jtData.convertRowIndexToModel(selectedRow);
            DefaultTableModel model = (DefaultTableModel) jtData.getModel();

            String pkgUrl = (String) model.getValueAt(modelRowIndex, getColumnIndexByName("PKG direct link"));
            
            if ("MISSING".equals(pkgUrl)) {
                JOptionPane.showMessageDialog(this, "You cannot download this game because the download link is not registered.", "Error", JOptionPane.ERROR_MESSAGE);
                return;
            } else if ("CART ONLY".equals(pkgUrl)) {
                JOptionPane.showMessageDialog(this, "This game is available in cart only.", "Information", JOptionPane.INFORMATION_MESSAGE);
                return;
            } else if ("NOT REQUIRED".equals(pkgUrl)) {
                JOptionPane.showMessageDialog(this, "No download required", "Information", JOptionPane.INFORMATION_MESSAGE);
                return;
            }

            String name = (String) model.getValueAt(modelRowIndex, getColumnIndexByName("Name"));
            String fileSize = (String) model.getValueAt(modelRowIndex, getColumnIndexByName("File Size"));
            String zRif = (String) model.getValueAt(modelRowIndex, getColumnIndexByName("zRIF"));
            String region = (String) model.getValueAt(modelRowIndex, getColumnIndexByName("Region"));

            int option = JOptionPane.showConfirmDialog(this,
                    "Do you want to add " + name + " (" + fileSize + ") to download list?",
                    "Download List",
                    JOptionPane.YES_NO_OPTION);

            if (option == JOptionPane.YES_OPTION) {
                if (downloadList.stream().anyMatch(g -> g.getPkgUrl().equals(pkgUrl))) {
                    JOptionPane.showMessageDialog(this, "The game is already in the download list.");
                    return;
                }

                Game game = new Game();
                game.setTitle(name);
                game.setPkgUrl(pkgUrl);
                game.setzRif(zRif);
                game.setRegion(region);
                
                if (jrbPsp.isSelected()) game.setConsole(Console.PSP);
                else if (jrbPsvita.isSelected()) game.setConsole(Console.PSVITA);
                else if (jrbPsx.isSelected()) game.setConsole(Console.PSX);

                downloadList.add(game);
                System.out.println("Added to list: " + game);
            }
        }
    }

    private void jbDownloadListActionPerformed(java.awt.event.ActionEvent evt) {
        JTable table = new JTable();
        DefaultTableModel model = (DefaultTableModel) table.getModel();
        model.addColumn("Name");
        model.addColumn("Region");
        model.addColumn("Console");
        model.addColumn("URL");

        for (Game game : downloadList) {
            model.addRow(new Object[]{game.getTitle(), game.getRegion(), game.getConsole(), game.getPkgUrl()});
        }

        JButton removeButton = new JButton("Remove Selected");
        removeButton.addActionListener(e -> {
            int[] selectedRows = table.getSelectedRows();
            for (int i = selectedRows.length - 1; i >= 0; i--) {
                int modelRow = table.convertRowIndexToModel(selectedRows[i]);
                String url = (String) model.getValueAt(modelRow, 3);
                downloadList.removeIf(g -> g.getPkgUrl().equals(url));
                model.removeRow(modelRow);
            }
        });

        JButton clearButton = new JButton("Clear List");
        clearButton.addActionListener(e -> {
            downloadList.clear();
            model.setRowCount(0);
        });

        JButton downloadButton = new JButton("Download");
        downloadButton.addActionListener(this);

        JOptionPane.showMessageDialog(null, new Object[]{new JScrollPane(table), downloadButton, removeButton, clearButton}, "Download List", JOptionPane.PLAIN_MESSAGE);
    }// GEN-LAST:event_jtDataMousePressed

    private void jbResumeAndPauseActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_jbResumeAndPauseActionPerformed
        // Cambiar el estado de la descarga
        downloadPaused = !downloadPaused;
        // Actualizar el texto del botón
        if (downloadPaused) {
            jbResumeAndPause.setText("Resume");
        } else {
            jbResumeAndPause.setText("Pause");
        }
        downloadService.setPaused(downloadPaused);
        refreshPauseVisuals();
    }// GEN-LAST:event_jbResumeAndPauseActionPerformed

    private void jbSettingActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_jbSettingActionPerformed
        Config config = new Config(configManager);
        config.setLocationRelativeTo(null);
        config.setResizable(false);
        config.setVisible(true);

        // metodo para cargar los valores de las url en los campos de texto desde el
        // archivo config.properties
        config.loadValues();

    }// GEN-LAST:event_jbSettingActionPerformed

    private void jrbPspActionPerformed(java.awt.event.ActionEvent evt) {// GEN-FIRST:event_jrbPspActionPerformed
        fillTable();
    }// GEN-LAST:event_jrbPspActionPerformed

    // si el usuario selecciona la consola psp, se cargan los datos de la consola
    // psp, si selecciona psvita, se cargan los datos de psvita por medio de los
    // metodos fillTableAndComboBoxPsp y fillTableAndComboBoxVita usando
    // JradioButton para seleccionar la consola "jrbPsp" y "jrbPsvita

    public void fillTable() {
        if (jrbPsp.isSelected()) {
            fillTableAndComboBox("Psp");
        } else if (jrbPsvita.isSelected()) {
            fillTableAndComboBox("Psvita");
        } else if (jrbPsx.isSelected()) {
            fillTableAndComboBox("Psx");
        }
    }

    public void fillTableAndComboBox(String consoleName) {
        Console console;
        try {
            console = Console.fromDisplayName(consoleName);
        } catch (IllegalArgumentException e) {
            e.printStackTrace();
            return;
        }

        List<Game> games;
        try {
            games = gameRepository.loadGames(console);
        } catch (Exception e) {
            e.printStackTrace();
            return;
        }

        // Define columns expected by the UI
        String[] columnNames = {"Name", "Region", "PKG direct link", "zRIF", "File Size"};
        DefaultTableModel model = new DefaultTableModel(columnNames, 0);

        for (Game game : games) {
            model.addRow(new Object[]{
                    game.getTitle(),
                    game.getRegion(),
                    game.getPkgUrl(),
                    game.getzRif(),
                    convertFileSize(game.getFileSize())
            });
        }

        originalModel = model;
        jtData.setModel(model);

        // Create the TableRowSorter
        rowSorter = new TableRowSorter<>(model);
        jtData.setRowSorter(rowSorter);

        // Update Region ComboBox
        int regionColumnIndex = 1; // "Region" is at index 1
        java.util.Set<String> regionSet = new java.util.TreeSet<>();
        for (int row = 0; row < model.getRowCount(); row++) {
            String region = (String) model.getValueAt(row, regionColumnIndex);
            if (region != null) {
                regionSet.add(region);
            }
        }

        jcbRegion.removeAllItems();
        jcbRegion.addItem("All regions");
        for (String region : regionSet) {
            jcbRegion.addItem(region);
        }
        jcbRegion.setSelectedIndex(0);
    }

    private String convertFileSize(long fileSize) {
        double fileSizeMiB = fileSize / (1024 * 1024.0);
        return String.format("%.1f MiB", fileSizeMiB);
    }

    private void filtrarTablaPorTextoYRegion(String searchText, String region) {
        System.out.println("Search Text: " + searchText);
        System.out.println("Region: " + region);
        
        if (region == null) {
            return;
        }

        // Crear un RowFilter para filtrar por el texto ingresado y la región
        // seleccionada
        RowFilter<DefaultTableModel, Integer> rowFilterByText = null;
        RowFilter<DefaultTableModel, Integer> rowFilterByRegion = null;
        try {
            // Filtrar por texto ingresado
            rowFilterByText = RowFilter.regexFilter("(?i)" + searchText); // Ignore case
            System.out.println("Row Filter By Text: " + rowFilterByText);
            // Filtrar por región seleccionada si no se selecciona "Todas las regiones"
            if (!region.equals("All regions")) {
                rowFilterByRegion = RowFilter.regexFilter("(?i)" + region, getColumnIndexByName("Region"));
                System.out.println("Row Filter By Region: " + rowFilterByRegion);
            }

            // Combinar los filtros
            List<RowFilter<DefaultTableModel, Integer>> filters = new ArrayList<>();
            if (rowFilterByText != null)
                filters.add(rowFilterByText);
            if (rowFilterByRegion != null)
                filters.add(rowFilterByRegion);

            RowFilter<DefaultTableModel, Integer> combinedRowFilter = RowFilter.andFilter(filters);

            // Establecer el RowFilter en el TableRowSorter
            rowSorter.setRowFilter(combinedRowFilter);
        } catch (java.util.regex.PatternSyntaxException e) {
            e.printStackTrace(); // Imprimir la traza de la excepción para depuración
            // Si hay un error en la expresión regular, simplemente no aplicamos ningún
            // filtro
            rowSorter.setRowFilter(null);
            return;
        }
    }

    private int getColumnIndexByName(String columnName) {
        for (int i = 0; i < originalModel.getColumnCount(); i++) {
            if (originalModel.getColumnName(i).equals(columnName)) {
                return i;
            }
        }
        return -1; // Si no se encuentra la columna, retornar -1
    }

    @Override
    public void actionPerformed(ActionEvent e) {
        if (e.getActionCommand().equals("Download")) {
            startDownloads();
        }
    }

    private void startDownloads() {
        if (downloadList.isEmpty()) {
            JOptionPane.showMessageDialog(this, "The download list is empty.");
            return;
        }

        if (downloading) {
            JOptionPane.showMessageDialog(this, "Downloads in progress.");
            return;
        }

        downloading = true;
        jbResumeAndPause.setEnabled(true);

        resetDownloadUI(downloadList);

        final int concurrency = Math.max(1, configManager.getSimultaneousDownloads());
        ExecutorService executor = Executors.newFixedThreadPool(concurrency);

        for (Game game : new ArrayList<>(downloadList)) {
            executor.submit(() -> {
                String fileName = game.getFileName();
                String destPath = "games/" + fileName;
                downloadService.downloadFile(game.getPkgUrl(), destPath, new DownloadService.DownloadListener() {
                    @Override
                    public void onProgress(long bytesDownloaded, long totalBytes) {
                        SwingUtilities.invokeLater(() -> updateDownloadProgress(game, bytesDownloaded, totalBytes));
                    }
                    @Override
                    public void onComplete(File file) {
                        SwingUtilities.invokeLater(() -> {
                            markDownloadCompleted(game);
                            if (game.getzRif() != null && !game.getzRif().isEmpty()) {
                                packageService.extractPackage(fileName, game.getzRif(), game.getConsole());
                            }
                        });
                    }
                    @Override
                    public void onError(Exception e) {
                        e.printStackTrace();
                        SwingUtilities.invokeLater(() -> markDownloadError(game));
                    }
                });
            });
        }

        new Thread(() -> {
            executor.shutdown();
            try {
                executor.awaitTermination(Long.MAX_VALUE, java.util.concurrent.TimeUnit.NANOSECONDS);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            // Final UI cleanup happens as each bar completes.
        }).start();
    }

    private void resetDownloadUI(List<Game> games) {
        SwingUtilities.invokeLater(() -> {
            downloadsPanel.removeAll();
            progressBarsByUrl.clear();
            lastBytesByUrl.clear();
            lastTimeByUrl.clear();
            smoothedSpeedMibByUrl.clear();
            lastUiUpdateMsByUrl.clear();
            lastProgressPercentByUrl.clear();
            activeDownloadCount = games.size();
            for (Game g : games) {
                javax.swing.JProgressBar bar = new javax.swing.JProgressBar();
                bar.setStringPainted(true);
                bar.setIndeterminate(true);
                bar.setString(g.getTitle() + " – Starting… – " + g.getConsole());
                progressBarsByUrl.put(g.getPkgUrl(), bar);
                lastBytesByUrl.put(g.getPkgUrl(), 0L);
                lastTimeByUrl.put(g.getPkgUrl(), System.currentTimeMillis());
                lastUiUpdateMsByUrl.put(g.getPkgUrl(), 0L);
                lastProgressPercentByUrl.put(g.getPkgUrl(), -1);
                downloadsPanel.add(bar);
            }
            downloadsPanel.revalidate();
            downloadsPanel.repaint();
            jbResumeAndPause.setEnabled(true);
            refreshPauseVisuals();
        });
    }

    private void updateDownloadProgress(Game game, long bytesDownloaded, long totalBytes) {
        javax.swing.JProgressBar bar = progressBarsByUrl.get(game.getPkgUrl());
        if (bar == null) return;
        long now = System.currentTimeMillis();
        long lastTime = lastTimeByUrl.getOrDefault(game.getPkgUrl(), now);
        long lastBytes = lastBytesByUrl.getOrDefault(game.getPkgUrl(), 0L);
        long deltaTime = now - lastTime; // ms
        long deltaBytes = bytesDownloaded - lastBytes;
        lastTimeByUrl.put(game.getPkgUrl(), now);
        lastBytesByUrl.put(game.getPkgUrl(), bytesDownloaded);

        // Instant speed (MiB/s)
        Double smoothed = smoothedSpeedMibByUrl.get(game.getPkgUrl());
        double instantMib = -1.0;
        if (deltaTime > 150 && deltaBytes > 0) { // require minimum interval
            double bytesPerSec = (deltaBytes / (deltaTime / 1000.0));
            instantMib = bytesPerSec / (1024 * 1024.0);
            if (smoothed == null) {
                smoothed = instantMib; // first measurement
            } else {
                double alpha = 0.25; // smoothing factor
                smoothed = smoothed + alpha * (instantMib - smoothed);
            }
            smoothedSpeedMibByUrl.put(game.getPkgUrl(), smoothed);
        }

        // Determine progress percent (if known)
        int progressPercent = -1;
        if (totalBytes > 0) {
            progressPercent = (int) ((bytesDownloaded * 100) / totalBytes);
            bar.setIndeterminate(false);
            bar.setValue(progressPercent);
        } else {
            bar.setIndeterminate(true);
        }

        // Throttle UI updates: update text only if progress changed or 1s elapsed
        long lastUi = lastUiUpdateMsByUrl.getOrDefault(game.getPkgUrl(), 0L);
        int lastProgressStored = lastProgressPercentByUrl.getOrDefault(game.getPkgUrl(), -999);
        boolean progressChanged = progressPercent != lastProgressStored && progressPercent >= 0;
        boolean timeElapsed = (now - lastUi) >= 1000; // 1s throttle
        boolean first = lastUi == 0L;
        if (progressChanged || timeElapsed || first || bar.isIndeterminate()) {
            lastUiUpdateMsByUrl.put(game.getPkgUrl(), now);
            lastProgressPercentByUrl.put(game.getPkgUrl(), progressPercent);
            String speedStr;
            Double current = smoothedSpeedMibByUrl.get(game.getPkgUrl());
            if (current == null || current <= 0) {
                speedStr = "—"; // em dash for unknown
            } else {
                speedStr = String.format("%.2f MiB/s", current);
            }
            String base;
            if (bar.isIndeterminate()) {
                base = String.format("%s – %d bytes – %s – %s", game.getTitle(), bytesDownloaded, game.getConsole(), speedStr);
            } else {
                base = String.format("%s – %d%% – %s – %s", game.getTitle(), progressPercent, game.getConsole(), speedStr);
            }
            if (downloadPaused) base += " (Paused)";
            bar.setString(base);
        }
    }

    private void markDownloadCompleted(Game game) {
        javax.swing.JProgressBar bar = progressBarsByUrl.get(game.getPkgUrl());
        if (bar != null) {
            bar.setIndeterminate(false);
            bar.setValue(100);
            bar.setString(game.getTitle() + " – Completed – " + game.getConsole());
        }
        activeDownloadCount--;
        checkAllDownloadsFinished();
    }

    private void markDownloadError(Game game) {
        javax.swing.JProgressBar bar = progressBarsByUrl.get(game.getPkgUrl());
        if (bar != null) {
            bar.setIndeterminate(false);
            bar.setString(game.getTitle() + " – Error – " + game.getConsole());
        }
        activeDownloadCount--;
        checkAllDownloadsFinished();
    }

    private void checkAllDownloadsFinished() {
        if (activeDownloadCount <= 0) {
            jbResumeAndPause.setEnabled(false);
            downloadList.clear();
        }
    }

    private void refreshPauseVisuals() {
        for (javax.swing.JProgressBar bar : progressBarsByUrl.values()) {
            String s = bar.getString();
            if (s == null) continue;
            if (downloadPaused) {
                if (!s.endsWith("(Paused)")) {
                    bar.setString(s + " (Paused)");
                }
            } else {
                if (s.endsWith("(Paused)")) {
                    bar.setString(s.substring(0, s.length() - 9));
                }
            }
        }
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup bgConsoles;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JButton jbDownloadList;
    private javax.swing.JButton jbRefresh;
    private javax.swing.JButton jbResumeAndPause;
    private javax.swing.JButton jbSetting;
    private javax.swing.JLabel jbsearch;
    private javax.swing.JComboBox<String> jcbRegion;
    // Removed single progress bar; using downloadsPanel instead.
    private javax.swing.JRadioButton jrbPsp;
    private javax.swing.JRadioButton jrbPsvita;
    private javax.swing.JRadioButton jrbPsx;
    private javax.swing.JTable jtData;
    private javax.swing.JTextField jtfSearch;
    // End of variables declaration//GEN-END:variables

    private void jbRefreshActionPerformed(java.awt.event.ActionEvent evt) {
        fillTable();
    }

    private void jcbRegionItemStateChanged(java.awt.event.ItemEvent evt) {
        filtrarTablaPorTextoYRegion(jtfSearch.getText(), (String) jcbRegion.getSelectedItem());
    }

    private void jrbPsvitaActionPerformed(java.awt.event.ActionEvent evt) {
        fillTable();
    }

    private void jrbPsxActionPerformed(java.awt.event.ActionEvent evt) {
        fillTable();
    }
}
